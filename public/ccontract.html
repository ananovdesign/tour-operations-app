<script>
    document.addEventListener('DOMContentLoaded', function () {
        // --- UI Elements ---
        const tabNav = document.getElementById('tab-nav');
        const tabContents = document.querySelectorAll('.tab-content');
        const addTouristBtn = document.getElementById('add-tourist-btn');
        const touristsTableBody = document.getElementById('tourists-table-body');
        const startDateInput = document.getElementById('startDate');
        const endDateInput = document.getElementById('endDate');
        const durationInput = document.getElementById('tripDuration');
        const generatePdfBtn = document.getElementById('generate-pdf-btn');
        const loadingModal = document.getElementById('loading-modal');

        let touristCount = 0; // Tracks the number of *manually added* tourist rows
        let isReservationDataLoaded = false; // Flag to indicate if data came from React

        // --- Initial Setup ---
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('signingDate').value = today;

        // --- Event Listeners ---
        tabNav.addEventListener('click', (e) => {
            if (e.target.tagName === 'BUTTON') {
                const targetTab = e.target.dataset.tab;
                tabNav.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
                e.target.classList.add('active');
                tabContents.forEach(content => {
                    content.classList.toggle('hidden', content.id !== targetTab);
                });
            }
        });

        addTouristBtn.addEventListener('click', () => addTouristRow(false)); // False means not pre-filled
        
        touristsTableBody.addEventListener('click', function(e) {
            const removeBtn = e.target.closest('.remove-tourist-btn');
            if (removeBtn && !isReservationDataLoaded) { // Only allow removing if not pre-filled
                removeBtn.closest('tr').remove();
                updateTouristRowNumbers();
            } else if (removeBtn && isReservationDataLoaded) {
                alert("Cannot remove tourists when data is loaded from a reservation. Please edit the reservation directly in the main application.");
            }
        });

        // Set inputs to readOnly if data is loaded from reservation
        const setFormFieldsReadOnly = (readOnly) => {
            document.querySelectorAll('#contract-form input, #contract-form textarea, #contract-form select').forEach(input => {
                // Allow contractNumber, signingDate, specialReqs, otherPayments, childDiscount, adultDiscount, singleRoomFee, extraExcursion, insurance, paymentTerms to be editable even if reservation data is loaded
                const editableFields = ['contractNumber', 'signingDate', 'specialReqs', 'otherPayments', 'childDiscount', 'adultDiscount', 'singleRoomFee', 'extraExcursion', 'insurance', 'paymentTerms', 'mainTouristName', 'mainTouristEGN', 'mainTouristIdCard', 'mainTouristAddress', 'mainTouristPhone', 'mainTouristEmail', 'startDate', 'endDate', 'accommodationDesc', 'roomType', 'mealsDesc', 'totalPrice', 'finalAmount', 'depositAmount', 'finalPayment', 'transportDesc', 'departureInfo', 'returnInfo'];
                if (!editableFields.includes(input.id)) { // Only set readOnly for fields that are NOT in the editable list
                     input.readOnly = readOnly;
                     input.classList.toggle('bg-gray-100', readOnly);
                }
            });
            // Hide the 'Add Tourist' button if data is loaded from reservation
            addTouristBtn.classList.toggle('hidden', readOnly);
        };

        startDateInput.addEventListener('change', calculateDuration);
        endDateInput.addEventListener('change', calculateDuration);

        generatePdfBtn.addEventListener('click', handlePdfGeneration);

        // --- Functions ---
        function addTouristRow(isPreFilled = false, touristData = {}) {
            touristCount++;
            const row = document.createElement('tr');
            row.classList.add('bg-white', 'border-b', 'hover:bg-gray-50');
            row.innerHTML = `
                <td class="px-4 py-3 text-center font-medium text-gray-700"></td>
                <td class="px-6 py-2"><input type="text" class="form-input w-full rounded-md border-gray-300 text-sm tourist-name" placeholder="Трите имена" value="${touristData.fullName || ''}" ${isPreFilled ? 'readonly' : ''}></td>
                <td class="px-6 py-2"><input type="text" class="form-input w-full rounded-md border-gray-300 text-sm tourist-egn" placeholder="ЕГН/ЛНЧ" value="${touristData.realId || ''}" ${isPreFilled ? 'readonly' : ''}></td>
                <td class="px-6 py-2"><input type="text" class="form-input w-full rounded-md border-gray-300 text-sm tourist-id" placeholder="№ паспорт/л.к." value="${touristData.id || ''}" ${isPreFilled ? 'readonly' : ''}></td>
                <td class="px-4 py-2 text-center">
                    ${!isPreFilled ? `<button type="button" class="text-red-500 hover:text-red-700 remove-tourist-btn p-1 rounded-full hover:bg-red-100 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg>
                    </button>` : ''}
                </td>
            `;
            touristsTableBody.appendChild(row);
            updateTouristRowNumbers();
            // Add readonly class to input fields
            if (isPreFilled) {
                row.querySelectorAll('input').forEach(input => {
                    input.classList.add('bg-gray-100');
                });
            }
        }

        function updateTouristRowNumbers() {
            const rows = touristsTableBody.querySelectorAll('tr');
            rows.forEach((row, index) => {
                row.querySelector('td:first-child').textContent = index + 1;
            });
            touristCount = rows.length;
        }

        function calculateDuration() {
            const startDate = new Date(startDateInput.value);
            const endDate = new Date(endDateInput.value);
            if (startDateInput.value && endDateInput.value && endDate >= startDate) {
                const diffTime = Math.abs(endDate - startDate);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                durationInput.value = `${diffDays + 1} дни / ${diffDays} нощувки`;
            } else {
                durationInput.value = '';
            }
        }
        
        // Function to fill the form with reservation data
        function fillFormWithReservationData(reservation) {
            isReservationDataLoaded = true;
            setFormFieldsReadOnly(true); // Set most fields to read-only

            // Clear existing tourist rows before adding new ones
            touristsTableBody.innerHTML = '';
            touristCount = 0; // Reset tourist counter

            // Populate main tourist/lead guest details
            const leadTourist = reservation.tourists?.[0];
            if (leadTourist) {
                document.getElementById('mainTouristName').value = `${leadTourist.firstName || ''} ${leadTourist.fatherName || ''} ${leadTourist.familyName || ''}`.trim();
                document.getElementById('mainTouristEGN').value = leadTourist.realId || '';
                document.getElementById('mainTouristIdCard').value = leadTourist.id || '';
                document.getElementById('mainTouristAddress').value = `${leadTourist.address || ''}, ${leadTourist.city || ''}, ${leadTourist.postCode || ''}`.trim();
                document.getElementById('mainTouristPhone').value = leadTourist.phone || '';
                document.getElementById('mainTouristEmail').value = leadTourist.email || '';
            }

            // Populate accompanying tourists
            if (reservation.tourists && reservation.tourists.length > 1) {
                for (let i = 1; i < reservation.tourists.length; i++) {
                    const tourist = reservation.tourists[i];
                    addTouristRow(true, { // Pass true for isPreFilled
                        fullName: `${tourist.firstName || ''} ${tourist.fatherName || ''} ${tourist.familyName || ''}`.trim(),
                        realId: tourist.realId || '',
                        id: tourist.id || ''
                    });
                }
            } else if (reservation.tourists && reservation.tourists.length === 1) {
                // If only one tourist, ensure other tourists section is clear
                 touristsTableBody.innerHTML = '';
                 touristCount = 0;
            }


            // Populate reservation details
            document.getElementById('contractNumber').value = reservation.reservationNumber || '';
            document.getElementById('signingDate').value = reservation.creationDate || today; // Use creationDate for signingDate
            document.getElementById('startDate').value = reservation.checkIn || '';
            document.getElementById('endDate').value = reservation.checkOut || '';
            calculateDuration(); // Recalculate duration based on new dates

            document.getElementById('transportDesc').value = 'СОБСТВЕН ТРАНСПОРТ - ОСИГУРЕН ОТ ТУРИСТИТЕ';
            document.getElementById('departureInfo').value = 'СОБСТВЕН ТРАНСПОРТ';
            document.getElementById('returnInfo').value = 'СОБСТВЕН ТРАНСПОРТ';
            
            document.getElementById('accommodationDesc').value = `${reservation.hotel || ''}, ${reservation.place || ''}, ${reservation.totalNights || 0} нощувки`;
            document.getElementById('roomType').value = reservation.roomType || '';
            document.getElementById('mealsDesc').value = reservation.food || '';
            document.getElementById('otherServices').value = 'Водач-представител на фирмата по време на цялото пътуване;'; // Default
            document.getElementById('specialReqs').value = reservation.specialReqs || ''; // If you add specialReqs to reservation form
            
            document.getElementById('totalPrice').value = (reservation.finalAmount || 0).toFixed(2);
            document.getElementById('insurance').value = 'Медицинска застраховка "Помощ при пътуване" с лимит 5000 евро'; // Default
            document.getElementById('finalAmount').value = (reservation.finalAmount - reservation.depositAmount).toFixed(2);
            document.getElementById('depositAmount').value = (reservation.depositAmount || 0).toFixed(2);

            const finalPaymentDate = new Date(reservation.checkIn);
            finalPaymentDate.setDate(finalPaymentDate.getDate() - 30); // 30 days before check-in
            const formattedFinalPaymentDate = finalPaymentDate.toISOString().split('T')[0];

            document.getElementById('finalPayment').value = `${(reservation.finalAmount - reservation.depositAmount).toFixed(2)} лв. до ${formatDate(formattedFinalPaymentDate)}`;
            document.getElementById('paymentTerms').value = `Плащането е в брой в нашия офис в Ракитово, ул. Христо Ботев 4 или по банков път със следните данни:\nIBAN BG87BPBI79301036586601\nПолучател: ДАЙНАМЕКС ТУР\nОснование: ${reservation.reservationNumber || ''}`;


            // Show success message
            // alert('Contract form populated with reservation data!'); // Removed for smoother UX
        }

        async function handlePdfGeneration() {
            loadingModal.classList.remove('hidden');
            populatePdfContent();

            const { jsPDF } = window.jspdf;
            const logicalPages = document.querySelectorAll('.pdf-logical-page');
            const doc = new jsPDF({ orientation: 'p', unit: 'mm', format: 'a4' });
            const pdfPageWidth = doc.internal.pageSize.getWidth();
            const pdfPageHeight = doc.internal.pageSize.getHeight();

            try {
                for (let i = 0; i < logicalPages.length; i++) {
                    const pageContent = logicalPages[i];
                    
                    if (i > 0) {
                        doc.addPage();
                    }

                    const canvas = await html2canvas(pageContent, {
                        scale: 2, useCORS: true, width: pageContent.offsetWidth,
                    });

                    const imgData = canvas.toDataURL('image/png');
                    const ratio = canvas.height / canvas.width;
                    const pdfImgHeight = pdfPageWidth * ratio;
                    let heightLeft = pdfImgHeight;
                    let position = 0;

                    doc.addImage(imgData, 'PNG', 0, position, pdfPageWidth, pdfImgHeight);
                    heightLeft -= pdfPageHeight;

                    while (heightLeft > 1) {
                        position -= pdfPageHeight;
                        doc.addPage();
                        doc.addImage(imgData, 'PNG', 0, position, pdfPageWidth, pdfImgHeight);
                        heightLeft -= pdfPageHeight;
                    }
                }
                
                const fileName = `Dogovor-${document.getElementById('contractNumber').value || 'XXXX'}.pdf`;
                doc.save(fileName);

            } catch (err) {
                console.error("Error generating PDF:", err);
                alert("Възникна грешка при генерирането на PDF файла. Моля, проверете конзолата за повече информация.");
            } finally {
                loadingModal.classList.add('hidden');
            }
        }

        function populatePdfContent() {
            const formatDate = (dateString) => {
                if (!dateString) return '..................';
                const date = new Date(dateString);
                // Ensure correct day, month, year formatting for Bulgarian locale
                const day = String(date.getDate()).padStart(2, '0');
                const month = String(date.getMonth() + 1).padStart(2, '0'); // Months are 0-indexed
                const year = date.getFullYear();
                return `${day}.${month}.${year}г.`;
            };

            // Helper to get value from input and provide fallback or suffix
            const getValue = (id, fallback = '..................', suffix = '') => {
                const element = document.getElementById(id);
                return (element && element.value !== '' ? element.value : fallback) + suffix;
            };
            const getOptionalValue = (id, fallback = 'Няма.') => document.getElementById(id).value || fallback;


            // Populate contract data
            document.getElementById('pdf-contractNumber').textContent = getValue('contractNumber', '').replace('..................', '');
            document.getElementById('pdf-signingDate').textContent = formatDate(document.getElementById('signingDate').value);
            document.getElementById('pdf-mainTouristName').textContent = getValue('mainTouristName');
            document.getElementById('pdf-mainTouristEGN').textContent = getValue('mainTouristEGN');
            document.getElementById('pdf-mainTouristIdCard').textContent = getValue('mainTouristIdCard');
            document.getElementById('pdf-mainTouristAddress').textContent = getValue('mainTouristAddress');
            document.getElementById('pdf-mainTouristPhone').textContent = getValue('mainTouristPhone');
            document.getElementById('pdf-mainTouristEmail').textContent = getValue('mainTouristEmail');
            
            // Populate trip details
            document.getElementById('pdf-startDate').textContent = formatDate(document.getElementById('startDate').value);
            document.getElementById('pdf-endDate').textContent = formatDate(document.getElementById('endDate').value);
            document.getElementById('pdf-tripDuration').textContent = getValue('tripDuration');
            document.getElementById('pdf-transportDesc').textContent = getValue('transportDesc');
            document.getElementById('pdf-departureInfo').textContent = getValue('departureInfo');
            document.getElementById('pdf-returnInfo').textContent = getValue('returnInfo');
            document.getElementById('pdf-accommodationDesc').textContent = getValue('accommodationDesc');
            document.getElementById('pdf-roomType').textContent = getValue('roomType');
            document.getElementById('pdf-mealsDesc').textContent = getValue('mealsDesc');
            document.getElementById('pdf-otherServices').textContent = getOptionalValue('otherServices');
            document.getElementById('pdf-specialReqs').textContent = getOptionalValue('specialReqs');

            // Populate financials
            document.getElementById('pdf-totalPrice').innerHTML = getValue('totalPrice', '0.00', ' лв.');
            document.getElementById('pdf-otherPayments').innerHTML = getOptionalValue('otherPayments');
            document.getElementById('pdf-childDiscount').innerHTML = getOptionalValue('childDiscount', 'Не е приложимо.');
            document.getElementById('pdf-adultDiscount').innerHTML = getOptionalValue('adultDiscount', 'Не е приложимо.');
            document.getElementById('pdf-singleRoomFee').innerHTML = getOptionalValue('singleRoomFee', 'Не е приложимо.');
            document.getElementById('pdf-extraExcursion').innerHTML = getOptionalValue('extraExcursion');
            document.getElementById('pdf-insurance').innerHTML = getValue('insurance');
            document.getElementById('pdf-finalAmount').innerHTML = getValue('finalAmount', '0.00', ' лв.');
            document.getElementById('pdf-paymentTerms').innerHTML = getValue('paymentTerms');
            document.getElementById('pdf-depositAmount').textContent = getValue('depositAmount');
            document.getElementById('pdf-finalPayment').innerHTML = getValue('finalPayment');

            // Populate declarations
            document.getElementById('pdf-declarationDate1').textContent = formatDate(document.getElementById('signingDate').value);
            document.getElementById('pdf-declarationDate2').textContent = formatDate(document.getElementById('signingDate').value);
            document.getElementById('pdf-declarationName').textContent = getValue('mainTouristName');
            document.getElementById('pdf-declarationEGN').textContent = getValue('mainTouristEGN');
            document.getElementById('pdf-declarationPhone').textContent = getValue('mainTouristPhone');
            document.getElementById('pdf-declarationContractNumber').textContent = getValue('contractNumber', '').replace('..................', '');

            // Build and insert the tourist table for the PDF
            const pdfTableContainer = document.getElementById('pdf-tourists-table-container');
            const formRows = touristsTableBody.querySelectorAll('tr');
            let tableHTML = '<h3 style="margin-top: 1em; font-weight: bold; text-align: center;">Данни на всички туристи в пакетното пътуване:</h3><table class="tourist-table-pdf"><thead><tr><th>№</th><th>Трите имена по док. за самоличност</th><th>ЕГН/ЛНЧ</th><th>№ паспорт/л.к.</th></tr></thead><tbody>';
            
            let allTouristsData = [];
            // Add main tourist to the list
            const mainTouristName = document.getElementById('mainTouristName').value || '';
            const mainTouristEGN = document.getElementById('mainTouristEGN').value || '';
            const mainTouristIdCard = document.getElementById('mainTouristIdCard').value || '';
            if (mainTouristName || mainTouristEGN || mainTouristIdCard) {
                allTouristsData.push({name: mainTouristName, egn: mainTouristEGN, id: mainTouristIdCard});
            }

            // Add accompanying tourists
            if (formRows.length > 0) {
                formRows.forEach((row) => {
                    const name = row.querySelector('.tourist-name').value || '';
                    const egn = row.querySelector('.tourist-egn').value || '';
                    const id = row.querySelector('.tourist-id').value || '';
                    allTouristsData.push({name, egn, id});
                });
            }
            
            // Generate 13 rows for the PDF table, filling with data or leaving blank
            for (let i = 0; i < 13; i++) {
                const data = allTouristsData[i];
                tableHTML += `<tr>
                    <td>${i + 1}</td>
                    <td>${data ? data.name : ''}</td>
                    <td>${data ? data.egn : ''}</td>
                    <td>${data ? data.id : ''}</td>
                </tr>`;
            }

            tableHTML += '</tbody></table>';
            pdfTableContainer.innerHTML = tableHTML;
        }

        // --- Message Listener from Parent (React) ---
        window.addEventListener('message', function(event) {
            // Ensure the message is from a trusted origin (your own app's domain)
            // In development, you might relax this, but for production, strict origin checking is crucial.
            // For now, we'll trust messages from Netlify deployment.
            // const allowedOrigin = 'https://your-netlify-app-name.netlify.app'; 
            // if (event.origin !== allowedOrigin) {
            //     console.warn('Received message from untrusted origin:', event.origin);
            //     return;
            // }

            if (event.data && event.data.type === 'LOAD_RESERVATION_DATA' && event.data.payload) {
                console.log('Received reservation data:', event.data.payload);
                fillFormWithReservationData(event.data.payload);
            }
        });
    });
</script>
