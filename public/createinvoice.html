<!DOCTYPE html>
<html lang="bg">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Фактура (EUR/BGN)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            padding: 2rem;
            box-sizing: border-box;
        }

        .container {
            display: flex;
            flex-direction: column;
            width: 100%;
            max-width: 2000px;
            gap: 2rem;
        }

        /* Panels */
        .panel {
            background-color: #ffffff;
            padding: 2.5rem;
            border-radius: 1rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
            flex: 1;
        }

        .input-form {
            min-width: 450px;
            flex: 1.2;
        }

        .invoice-preview {
            width: 100%;
            overflow-x: auto;
            flex: 1;
        }

        /* Typography */
        h2 {
            font-size: 2.25rem;
            font-weight: 700;
            margin-bottom: 2.5rem;
            color: #1a202c;
            text-align: center;
        }

        h3 {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 1.25rem;
            color: #2d3748;
            border-bottom: 1px solid #e2e8f0;
            padding-bottom: 0.75rem;
        }

        label {
            display: block;
            margin-bottom: 0.3rem;
            font-weight: 500;
            color: #4a5568;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        /* Inputs */
        input[type="text"],
        input[type="number"],
        textarea,
        select {
            width: 100%;
            padding: 0.75rem 1rem;
            margin-bottom: 1rem;
            border: 2px solid #e2e8f0;
            border-radius: 0.75rem;
            font-size: 0.95rem;
            color: #334155;
            transition: all 0.2s;
            background-color: #f8fafc;
        }

        input:focus, textarea:focus, select:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
            outline: none;
            background-color: #ffffff;
        }

        /* Tabs */
        .tab-nav {
            border-bottom: 1px solid #e2e8f0;
            margin-bottom: 2rem;
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }
        
        .tab-btn {
            padding: 0.75rem 1.5rem;
            font-size: 0.85rem;
            font-weight: 600;
            color: #64748b;
            border-radius: 0.75rem;
            transition: all 0.2s;
            background-color: transparent;
        }

        .tab-btn:hover {
            background-color: #f1f5f9;
            color: #3b82f6;
        }

        .tab-btn.active {
            background-color: #3b82f6;
            color: white;
            box-shadow: 0 4px 6px -1px rgba(59, 130, 246, 0.3);
        }

        /* Buttons */
        .button {
            display: inline-block;
            padding: 0.875rem 1.75rem;
            border-radius: 0.75rem;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
            border: none;
        }

        .button-primary {
            background-image: linear-gradient(to right, #3b82f6, #2563eb);
            color: #ffffff;
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.2);
        }

        .button-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(37, 99, 235, 0.3);
        }

        .button-add {
            background-color: #10b981;
            color: white;
            margin-top: 1rem;
        }
        .button-add:hover { background-color: #059669; }

        /* Items */
        .item-row {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
            margin-bottom: 0.75rem;
            align-items: flex-end;
            border: 1px solid #e2e8f0;
            padding: 1rem;
            border-radius: 0.75rem;
            background-color: #ffffff;
        }

        .item-row .input-group { flex: 1; min-width: 100px; }
        .item-row .input-group.description { flex: 3; min-width: 200px; }
        
        .remove-item-btn {
            background-color: #fee2e2;
            color: #ef4444;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: 0.2s;
            margin-bottom: 1rem; /* Align with inputs */
        }
        .remove-item-btn:hover { background-color: #fecaca; color: #dc2626; }

        .hidden { display: none; }

        /* Invoice Preview (A4) */
        #invoice-output {
            width: 210mm;
            margin: 0 auto;
            background-color: #fff;
            box-shadow: 0 0 20px rgba(0,0,0,0.08);
            padding: 20mm;
            box-sizing: border-box;
            font-size: 10pt;
            color: #333;
            line-height: 1.4;
        }

        /* Invoice styling details */
        #invoice-output h1 { font-size: 24pt; font-weight: 800; color: #1e293b; text-align: right; text-transform: uppercase; margin: 0; }
        #invoice-output .subtitle { font-size: 12pt; font-weight: 500; color: #64748b; text-align: right; margin-bottom: 2rem; }
        
        #invoice-output .header-grid { display: flex; justify-content: space-between; margin-bottom: 3rem; align-items: flex-start; }
        #invoice-output .logo-area img { max-height: 80px; max-width: 200px; }
        
        #invoice-output .meta-table { width: auto; border-collapse: collapse; margin-left: auto; }
        #invoice-output .meta-table td { padding: 4px 0 4px 15px; text-align: right; }
        #invoice-output .meta-label { color: #64748b; font-weight: 600; font-size: 9pt; text-transform: uppercase; }
        #invoice-output .meta-value { color: #1e293b; font-weight: 700; }

        #invoice-output .parties-grid { display: flex; gap: 2rem; margin-bottom: 3rem; }
        #invoice-output .party-col { flex: 1; }
        #invoice-output .party-title { font-size: 9pt; text-transform: uppercase; color: #64748b; font-weight: 700; border-bottom: 2px solid #e2e8f0; padding-bottom: 5px; margin-bottom: 10px; }
        #invoice-output .party-row { display: flex; margin-bottom: 4px; }
        #invoice-output .party-label { width: 80px; color: #64748b; font-size: 9pt; flex-shrink: 0; }
        #invoice-output .party-val { color: #1e293b; font-weight: 600; font-size: 10pt; }

        #invoice-output .items-table { width: 100%; border-collapse: collapse; margin-bottom: 2rem; }
        #invoice-output .items-table th { background-color: #f1f5f9; color: #475569; font-weight: 700; font-size: 8pt; text-transform: uppercase; padding: 10px; text-align: left; }
        #invoice-output .items-table td { border-bottom: 1px solid #e2e8f0; padding: 12px 10px; font-size: 10pt; color: #334155; }
        #invoice-output .items-table .num-col { text-align: right; white-space: nowrap; }
        
        #invoice-output .summary-grid { display: flex; justify-content: space-between; page-break-inside: avoid; }
        #invoice-output .summary-left { width: 50%; padding-top: 10px; }
        #invoice-output .summary-right { width: 45%; }
        
        #invoice-output .totals-table { width: 100%; border-collapse: collapse; }
        #invoice-output .totals-table td { padding: 6px 0; text-align: right; }
        #invoice-output .total-label { color: #64748b; font-size: 10pt; }
        #invoice-output .total-val { color: #1e293b; font-weight: 600; font-size: 10pt; }
        #invoice-output .grand-total-row td { border-top: 2px solid #334155; padding-top: 10px; margin-top: 5px; color: #0f172a; font-weight: 800; font-size: 12pt; }

        #invoice-output .footer-grid { display: flex; justify-content: space-between; margin-top: 3rem; border-top: 1px solid #e2e8f0; padding-top: 1.5rem; font-size: 9pt; color: #475569; page-break-inside: avoid; }
        #invoice-output .footer-col { width: 48%; }
        #invoice-output .footer-row { display: flex; justify-content: space-between; margin-bottom: 6px; }
        
        #invoice-output .small-note { font-size: 8pt; color: #94a3b8; margin-top: 2rem; text-align: center; }

        /* Print Styles */
        @media print {
            body { background: white; padding: 0; }
            .input-form, .print-button { display: none; }
            .container { max-width: none; }
            .invoice-preview { box-shadow: none; padding: 0; }
            #invoice-output { width: 100%; margin: 0; padding: 0; box-shadow: none; }
            @page { margin: 15mm; size: A4; }
        }
    </style>
</head>
<body>

    <div class="container lg:flex">
        <div class="panel input-form">
            <h2>Данни за фактура (EUR)</h2>

            <div class="tab-nav">
                <button data-tab="tab-our-company" class="tab-btn active">Наши данни</button>
                <button data-tab="tab-invoice-details" class="tab-btn">Документ</button>
                <button data-tab="tab-recipient-data" class="tab-btn">Клиент</button>
                <button data-tab="tab-items" class="tab-btn">Артикули</button>
                <button data-tab="tab-payment-other" class="tab-btn">Плащане</button>
            </div>

            <div id="tab-our-company" class="tab-content">
                <h3>Доставчик ("ДАЙНАМЕКС ТУР" ЕООД)</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label>Име на фирма</label>
                        <input type="text" id="ourCompanyName" value="ДАЙНАМЕКС ТУР ЕООД" readonly class="bg-gray-100">
                    </div>
                    <div>
                        <label>ЕИК / Булстат</label>
                        <input type="text" id="ourEIK" value="208193140" readonly class="bg-gray-100">
                    </div>
                    <div>
                        <label>ДДС Номер</label>
                        <input type="text" id="ourVATID" value="BG208193140" readonly class="bg-gray-100">
                    </div>
                    <div>
                        <label>МОЛ</label>
                        <input type="text" id="ourMOL" value="КРАСИМИР АНАНОВ" readonly class="bg-gray-100">
                    </div>
                    <div class="md:col-span-2">
                        <label>Адрес</label>
                        <input type="text" id="ourAddress" value="гр. Ракитово, ул. Васил Куртев 12А">
                    </div>
                    <div class="md:col-span-2">
                        <label>Телефон</label>
                        <input type="text" id="ourPhone" value="+359 879 97 64 46">
                    </div>
                </div>
            </div>

            <div id="tab-invoice-details" class="tab-content hidden">
                <h3>Данни за документа</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label>Номер на фактура</label>
                        <input type="text" id="invoiceNumber" placeholder="0000000001">
                    </div>
                    <div>
                        <label>Дата на издаване</label>
                        <input type="date" id="invoiceDate">
                    </div>
                    <div>
                        <label>Тип</label>
                        <select id="invoiceType">
                            <option value="Оригинал">Оригинал</option>
                            <option value="Копие">Копие</option>
                        </select>
                    </div>
                    <div>
                        <label>Дата данъчно събитие</label>
                        <input type="date" id="taxEventDate">
                    </div>
                </div>
            </div>

            <div id="tab-recipient-data" class="tab-content hidden">
                <h3>Получател (Клиент)</h3>
                <div class="grid grid-cols-1 gap-4">
                    <label>Име на фирма / Лице</label>
                    <input type="text" id="recipientName" placeholder="Име на клиента">
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label>ЕИК / ЛНЧ</label>
                            <input type="text" id="recipientIDNum" placeholder="ЕИК">
                        </div>
                        <div>
                            <label>ДДС Номер</label>
                            <input type="text" id="recipientVATID" placeholder="BG...">
                        </div>
                    </div>

                    <label>Адрес</label>
                    <input type="text" id="recipientAddress" placeholder="Адрес на клиента">

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label>МОЛ</label>
                            <input type="text" id="recipientMOL" placeholder="Материално отговорно лице">
                        </div>
                        <div>
                            <label>Телефон</label>
                            <input type="text" id="recipientPhone" placeholder="Телефон">
                        </div>
                    </div>
                </div>
            </div>

            <div id="tab-items" class="tab-content hidden">
                <h3>Стоки / Услуги (Цени в ЕВРО)</h3>
                <div id="itemsContainer">
                    </div>
                <button type="button" class="button button-add w-full" onclick="addItem()">+ Добави артикул</button>
            </div>

            <div id="tab-payment-other" class="tab-content hidden">
                <h3>Плащане и детайли</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label>Метод на плащане</label>
                        <select id="paymentMethod" onchange="toggleBankDetailsVisibility()">
                            <option value="bankTransfer">По банков път</option>
                            <option value="cash">В брой</option>
                        </select>
                    </div>
                    <div>
                        <label>ДДС ставка (0.20 = 20%)</label>
                        <input type="number" id="vatRate" step="0.01" value="0.00">
                    </div>
                </div>

                <div id="bankDetailsSection" class="bg-slate-50 p-4 rounded-xl border border-slate-200 mb-4">
                    <label class="text-blue-500 mb-2">Банкова сметка</label>
                    <div class="grid grid-cols-1 gap-2">
                        <div>
                            <label>Банка</label>
                            <input type="text" id="bank" value="ПОЩЕНСКА БАНКА">
                        </div>
                        <div>
                            <label>IBAN</label>
                            <input type="text" id="iban" value="BG87BPBI79301036586601">
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label>Основание на сделката</label>
                        <input type="text" id="transactionBasis" value="Туристическа услуга">
                    </div>
                    <div>
                        <label>Описание</label>
                        <input type="text" id="transactionDescription" value="Пакетно пътуване">
                    </div>
                    <div>
                        <label>Място на сделката</label>
                        <input type="text" id="transactionPlace" value="България">
                    </div>
                    <div>
                        <label>Съставил</label>
                        <input type="text" id="preparedBy" value="КРАСИМИР АНАНОВ">
                    </div>
                    <div>
                        <label>Получил</label>
                        <input type="text" id="receivedBy">
                    </div>
                </div>

                <div class="mt-4">
                    <label>Допълнителни бележки</label>
                    <textarea id="additionalNotes" rows="3">Основание за неначисляване на ДДС:"Режим на облагането на маржа в тур. услуги" - По член 86. ал.1 от ЗДДС.</textarea>
                </div>
            </div>

            <button type="button" class="button button-primary w-full print-button mt-8" onclick="window.print()">Генерирай и Принтирай</button>
        </div>

        <div class="panel invoice-preview">
            <div id="invoice-output">
                </div>
        </div>
    </div>

    <script>
        const EUR_TO_BGN = 1.95583;
        const LOGO_URL = "https://dynamexres.netlify.app/assets/Logo-BhKKBcxG.png";
        let itemCounter = 0;

        window.onload = function() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('invoiceDate').value = today;
            document.getElementById('taxEventDate').value = today;

            initTabs();
            addItem();
            toggleBankDetailsVisibility();
            generateInvoice();

            // Attach listeners
            document.querySelectorAll('input, textarea, select').forEach(el => {
                el.addEventListener('input', generateInvoice);
            });
        };

        function initTabs() {
            const btns = document.querySelectorAll('.tab-btn');
            const contents = document.querySelectorAll('.tab-content');

            btns.forEach(btn => {
                btn.addEventListener('click', (e) => {
                    btns.forEach(b => b.classList.remove('active'));
                    contents.forEach(c => c.classList.add('hidden'));
                    e.target.classList.add('active');
                    document.getElementById(e.target.dataset.tab).classList.remove('hidden');
                });
            });
        }

        function addItem() {
            itemCounter++;
            const container = document.getElementById('itemsContainer');
            const div = document.createElement('div');
            div.className = 'item-row';
            div.dataset.id = itemCounter;
            div.innerHTML = `
                <div class="input-group description">
                    <label>Описание</label>
                    <input type="text" class="item-desc" placeholder="Услуга/Стока">
                </div>
                <div class="input-group">
                    <label>Мярка</label>
                    <input type="text" class="item-unit" value="бр.">
                </div>
                <div class="input-group">
                    <label>Кол.</label>
                    <input type="number" class="item-qty" value="1" step="0.01">
                </div>
                <div class="input-group">
                    <label>Цена (EUR)</label>
                    <input type="number" class="item-price" value="0.00" step="0.01">
                </div>
                <div class="remove-item-btn" onclick="this.parentElement.remove(); generateInvoice()">✕</div>
            `;
            container.appendChild(div);
            div.querySelectorAll('input').forEach(i => i.addEventListener('input', generateInvoice));
        }

        function toggleBankDetailsVisibility() {
            const method = document.getElementById('paymentMethod').value;
            const bankSection = document.getElementById('bankDetailsSection');
            if(method === 'bankTransfer') bankSection.classList.remove('hidden');
            else bankSection.classList.add('hidden');
            generateInvoice();
        }

        // Convert EUR amount to words (in Bulgarian text saying "Euro")
        function amountToWordsEuro(num) {
            if (num === 0) return "нула евро";

            const units = ['', 'едно', 'две', 'три', 'четири', 'пет', 'шест', 'седем', 'осем', 'девет'];
            const unitsM = ['', 'един', 'два', 'три', 'четири', 'пет', 'шест', 'седем', 'осем', 'девет']; // Masculine for thousands
            const teens = ['десет', 'единадесет', 'дванадесет', 'тринадесет', 'четиринадесет', 'петнадесет', 'шестнадесет', 'седемнадесет', 'осемнадесет', 'деветнадесет'];
            const tens = ['', '', 'двадесет', 'тридесет', 'четиридесет', 'петдесет', 'шестдесет', 'седемдесет', 'осемдесет', 'деветдесет'];
            const hundreds = ['', 'сто', 'двеста', 'триста', 'четиристотин', 'петстотин', 'шестстотин', 'седемстотин', 'осемстотин', 'деветстотин'];

            function getPart(n, isThousand) {
                let s = '';
                if (n >= 100) { s += hundreds[Math.floor(n / 100)] + ' '; n %= 100; }
                if (n >= 20) { s += tens[Math.floor(n / 10)] + ' '; n %= 10; }
                else if (n >= 10) { s += teens[n - 10] + ' '; return s; }
                
                if (n > 0) {
                    if (isThousand && n <= 2) s += unitsM[n] + ' ';
                    else s += units[n] + ' ';
                }
                return s;
            }

            let intPart = Math.floor(num);
            let fracPart = Math.round((num - intPart) * 100);
            let res = '';

            if (intPart >= 1000) {
                let th = Math.floor(intPart / 1000);
                res += getPart(th, true) + (th === 1 ? 'хиляда ' : 'хиляди ');
                intPart %= 1000;
            }
            if (intPart > 0) res += getPart(intPart, false);
            if (res === '') res = 'нула ';

            res += 'евро';
            if (fracPart > 0) res += ' и ' + fracPart + ' евроцента';
            else res += ' и нула евроцента';

            return res.trim();
        }

        function formatDate(dateStr) {
            if(!dateStr) return '';
            const [y, m, d] = dateStr.split('-');
            return `${d}.${m}.${y}`;
        }

        function generateInvoice() {
            // Collect Data
            const data = {
                our: {
                    name: document.getElementById('ourCompanyName').value,
                    eik: document.getElementById('ourEIK').value,
                    vat: document.getElementById('ourVATID').value,
                    mol: document.getElementById('ourMOL').value,
                    addr: document.getElementById('ourAddress').value,
                    phone: document.getElementById('ourPhone').value
                },
                inv: {
                    num: document.getElementById('invoiceNumber').value,
                    date: formatDate(document.getElementById('invoiceDate').value),
                    type: document.getElementById('invoiceType').value,
                    taxDate: formatDate(document.getElementById('taxEventDate').value)
                },
                client: {
                    name: document.getElementById('recipientName').value,
                    id: document.getElementById('recipientIDNum').value,
                    vat: document.getElementById('recipientVATID').value,
                    addr: document.getElementById('recipientAddress').value,
                    mol: document.getElementById('recipientMOL').value,
                    phone: document.getElementById('recipientPhone').value
                },
                pay: {
                    method: document.getElementById('paymentMethod').value,
                    iban: document.getElementById('iban').value,
                    bank: document.getElementById('bank').value,
                    vatRate: parseFloat(document.getElementById('vatRate').value || 0),
                    basis: document.getElementById('transactionBasis').value,
                    desc: document.getElementById('transactionDescription').value,
                    place: document.getElementById('transactionPlace').value,
                    prep: document.getElementById('preparedBy').value,
                    rec: document.getElementById('receivedBy').value,
                    note: document.getElementById('additionalNotes').value
                }
            };

            // Process Items
            let itemsHTML = '';
            let totalBaseEUR = 0;

            document.querySelectorAll('.item-row').forEach((row, i) => {
                const desc = row.querySelector('.item-desc').value;
                const unit = row.querySelector('.item-unit').value;
                const qty = parseFloat(row.querySelector('.item-qty').value || 0);
                const priceEUR = parseFloat(row.querySelector('.item-price').value || 0);

                if(desc) {
                    const rowTotalEUR = qty * priceEUR;
                    totalBaseEUR += rowTotalEUR;
                    
                    // Conversions
                    const priceBGN = priceEUR * EUR_TO_BGN;
                    const rowTotalBGN = rowTotalEUR * EUR_TO_BGN;

                    itemsHTML += `
                        <tr>
                            <td>${i + 1}</td>
                            <td>${desc}</td>
                            <td>${unit}</td>
                            <td class="num-col">${qty}</td>
                            <td class="num-col">
                                <div>€ ${priceEUR.toFixed(2)}</div>
                                <div class="text-xs text-gray-500">${priceBGN.toFixed(2)} лв.</div>
                            </td>
                            <td class="num-col">
                                <div>€ ${rowTotalEUR.toFixed(2)}</div>
                                <div class="text-xs text-gray-500">${rowTotalBGN.toFixed(2)} лв.</div>
                            </td>
                        </tr>
                    `;
                }
            });

            // Totals
            const vatAmtEUR = totalBaseEUR * data.pay.vatRate;
            const grandTotalEUR = totalBaseEUR + vatAmtEUR;

            // BGN Totals (Calculated from final EUR to match display logic)
            const totalBaseBGN = totalBaseEUR * EUR_TO_BGN;
            const vatAmtBGN = vatAmtEUR * EUR_TO_BGN;
            const grandTotalBGN = grandTotalEUR * EUR_TO_BGN;

            const textAmount = amountToWordsEuro(grandTotalEUR);

            // Render Output
            const output = document.getElementById('invoice-output');
            output.innerHTML = `
                <div class="header-grid">
                    <div class="logo-area">
                        <img src="${LOGO_URL}" alt="Logo">
                    </div>
                    <div>
                        <h1>ФАКТУРА</h1>
                        <div class="subtitle">${data.inv.type}</div>
                        <table class="meta-table">
                            <tr><td class="meta-label">№</td><td class="meta-value text-xl">${data.inv.num}</td></tr>
                            <tr><td class="meta-label">ДАТА</td><td class="meta-value">${data.inv.date}</td></tr>
                        </table>
                    </div>
                </div>

                <div class="parties-grid">
                    <div class="party-col">
                        <div class="party-title">ПОЛУЧАТЕЛ</div>
                        <div class="party-row"><div class="party-label">Име:</div><div class="party-val">${data.client.name}</div></div>
                        <div class="party-row"><div class="party-label">Адрес:</div><div class="party-val">${data.client.addr}</div></div>
                        <div class="party-row"><div class="party-label">ЕИК:</div><div class="party-val">${data.client.id}</div></div>
                        <div class="party-row"><div class="party-label">ДДС №:</div><div class="party-val">${data.client.vat}</div></div>
                        <div class="party-row"><div class="party-label">МОЛ:</div><div class="party-val">${data.client.mol}</div></div>
                    </div>
                    <div class="party-col">
                        <div class="party-title">ДОСТАВЧИК</div>
                        <div class="party-row"><div class="party-label">Име:</div><div class="party-val">${data.our.name}</div></div>
                        <div class="party-row"><div class="party-label">Адрес:</div><div class="party-val">${data.our.addr}</div></div>
                        <div class="party-row"><div class="party-label">ЕИК:</div><div class="party-val">${data.our.eik}</div></div>
                        <div class="party-row"><div class="party-label">ДДС №:</div><div class="party-val">${data.our.vat}</div></div>
                        <div class="party-row"><div class="party-label">МОЛ:</div><div class="party-val">${data.our.mol}</div></div>
                    </div>
                </div>

                <table class="items-table">
                    <thead>
                        <tr>
                            <th style="width: 5%">№</th>
                            <th style="width: 45%">СТОКА / УСЛУГА</th>
                            <th style="width: 10%">МЯРКА</th>
                            <th style="width: 10%; text-align: right">КОЛ.</th>
                            <th style="width: 15%; text-align: right">ЦЕНА</th>
                            <th style="width: 15%; text-align: right">СУМА</th>
                        </tr>
                    </thead>
                    <tbody>${itemsHTML}</tbody>
                </table>

                <div class="summary-grid">
                    <div class="summary-left">
                        <div style="font-size: 9pt; color: #64748b; margin-bottom: 5px;">Словом (Сума за плащане):</div>
                        <div style="font-weight: 700; color: #1e293b; font-style: italic;">${textAmount}</div>
                        <div style="margin-top: 15px; font-size: 9pt;">
                            <strong>Плащане:</strong> ${data.pay.method === 'bankTransfer' ? 'По банков път' : 'В брой'}
                            ${data.pay.method === 'bankTransfer' ? `<br><strong>IBAN:</strong> ${data.pay.iban}<br><strong>Банка:</strong> ${data.pay.bank}` : ''}
                        </div>
                    </div>
                    <div class="summary-right">
                        <table class="totals-table">
                            <tr>
                                <td class="total-label">Данъчна основа:</td>
                                <td class="total-val">
                                    € ${totalBaseEUR.toFixed(2)}<br>
                                    <span style="font-size:8pt; color:#64748b">${totalBaseBGN.toFixed(2)} лв.</span>
                                </td>
                            </tr>
                            <tr>
                                <td class="total-label">ДДС ${(data.pay.vatRate*100).toFixed(0)}%:</td>
                                <td class="total-val">
                                    € ${vatAmtEUR.toFixed(2)}<br>
                                    <span style="font-size:8pt; color:#64748b">${vatAmtBGN.toFixed(2)} лв.</span>
                                </td>
                            </tr>
                            <tr class="grand-total-row">
                                <td>ОБЩО:</td>
                                <td>
                                    € ${grandTotalEUR.toFixed(2)}<br>
                                    <span style="font-size:10pt; font-weight: 600; color:#475569">${grandTotalBGN.toFixed(2)} лв.</span>
                                </td>
                            </tr>
                        </table>
                    </div>
                </div>

                <div class="footer-grid">
                    <div class="footer-col">
                        <div class="footer-row"><span>Данъчно събитие:</span> <strong>${data.inv.taxDate}</strong></div>
                        <div class="footer-row"><span>Основание:</span> <strong>${data.pay.basis}</strong></div>
                        <div class="footer-row"><span>Описание:</span> <strong>${data.pay.desc}</strong></div>
                    </div>
                    <div class="footer-col">
                        <div class="footer-row"><span>Място:</span> <strong>${data.pay.place}</strong></div>
                        <div class="footer-row"><span>Съставил:</span> <strong>${data.pay.prep}</strong></div>
                        <div class="footer-row"><span>Получил:</span> <strong>${data.pay.rec}</strong></div>
                    </div>
                </div>

                <div class="small-note">
                    ${data.pay.note}<br>
                    * Фиксиран курс: 1 EUR = 1.95583 BGN
                </div>
            `;
        }
    </script>
</body>
</html>
